<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Lottery on Blockchain</title>
<!--
Rainbow Theme
http://www.templatemo.com/tm-485-rainbow
-->
    <!-- load stylesheets -->
    <script
        src="http://code.jquery.com/jquery-3.3.1.js"
  integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60="
    crossorigin="anonymous"></script>
 

    <script src="http://code.jquery.com/ui/1.12.1/jquery-ui.js"
        integrity="sha256-T0Vest3yCU7pafRw9r+settMBX6JkKN06dqBnpQ8d30="
        crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,400">  <!-- Google web font "Open Sans" -->
    <link rel="stylesheet" href="font-awesome-4.5.0/css/font-awesome.min.css">                <!-- Font Awesome -->
    <link rel="stylesheet" href="css/bootstrap.min.css">                                      <!-- Bootstrap style -->
    <link rel="stylesheet" href="css/templatemo-style.css">                                   <!-- Templatemo style -->
    <link rel="stylesheet" href="load-awesome/ball-running-dots.css"> <!-- Spinning  -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.16/css/jquery.dataTables.min.css">                                   <!-- Templatemo style -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.16/css/jquery.dataTables.css">
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.js"></script>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/tabulator/3.5.1/css/tabulator.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/tabulator/3.5.1/js/tabulator.min.js"></script>

    <script type="text/javascript" charset="utf-8" src="https://unpkg.com/sweetalert2@7.19.1/dist/sweetalert2.all.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/promise-polyfill@7.1.0/dist/promise.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/sjcl/1.0.7/sjcl.min.js"></script>

    <script type="text/javascript" charset="utf-8">
        function showSpinner() {
            $("#spinner").css("display", "block");
            $("html").css("filter","brightness(50%)");
        }

        function hideSpinner() {
            $("#spinner").css("display", "none");
            $("html").css("filter","brightness(100%)");
        }

        $(document).ready(function() {
            $("html").css("height", "200%");
            $("body").css("height", "200%");
            function timestampToDatetime(unixtime) {
                var dateTime = new Date(unixtime * 1000);
                var u = dateTime.toISOString().replace('T',' ');
                u = u.substring(0, u.length - 8);
                return u;
            }

            $.ajax({
                url: "http://141.223.121.175:1185" + "/query-all-events",
                type: "POST", 
                data: "",
                success: function(responseData) {
                    var res = responseData.split("@");
                    var numOfPeer = 2
                    res.splice(0, 1);
                    for (var i = 0, l = res.length; i < l; i++) {
                        if (res[i][res[i].length - 1] == ',') {
                            //res[i] = res[i].substring(0, res[i].length - 2);
                            res[i] = res[i].slice(0, -1);
                        }
                    }

                var initTabledata = [ ];
                for (var i = 0; i < res.length; ++i) {
                    var obj = JSON.parse(res[i]);
                    var tsAnnouncementDate = obj.AnnouncementDate;

                    obj.Duedate = timestampToDatetime(obj.Duedate);
                    obj.IssueDate = timestampToDatetime(obj.IssueDate);
                    obj.AnnouncementDate = timestampToDatetime(obj.AnnouncementDate);
                    obj.WinnerList = obj.WinnerList.trim().split(",");
                    obj.EventHash = obj.EventHash;


                    for (var j = 0; j < obj.WinnerList.length; ++j) {
                        obj.WinnerList[j] = obj.WinnerList[j].trim();
                    }

                    obj.WinnerList = obj.WinnerList.join(",");
                    initTabledata[i] = {
                        id:(i+1),
                        name: obj.EventName,
                        announceDate: obj.AnnouncementDate,
                        tsAnnouncementDate: tsAnnouncementDate,
                        numOfRegistered: obj.NumOfRegistered,
                        numOfWinners: obj.NumOfWinners,
                        subscribe: 1, check: 1, verify:1,

                        status : obj.Status,
                        eventHash : obj.InputHash,
                        targetBlock : obj.FutureBlockHeight,
                        issueDate : obj.IssueDate,
                        dueDate : obj.Duedate,
                        verifiableKey : obj.VerifiableRandomkey,
                        winnerList : obj.WinnerList,
                        participantList : obj.MemberList,
                        script : obj.Script

                    }
                    // console.log("target block #", obj.FutureBlockHeight);
                }

                    // Redrwa the table
                    $("#allQueryTableReserved").tabulator("setData", initTabledata);
                    hideSpinner();
                },
                error: function() {
                    Swal("Fail");
                    hideSpinner();
                }
            });
			var printIcon = function(cell, formatterParams){ //plain text value
				return "<i class='fa fa-file'  style='font-size:28px;color:BlueViolet '></i>";
			};
			var printCheckVerify = function(cell, formatterParams){ //plain text value
				return "<i class='fa fa-check-square-o'  style='font-size:28px;color:BlueViolet '></i>";
			};

			var printScriptIcon = function(cell, formatterParams){ //plain text value
				return "<i class='fa fa-file-code-o'; style='font-size:28px;color:BlueViolet ' ></i>";
			};
			var printDrawIcon = function(cell, formatterParams){ //plain text value
				return "<i class='fa fa-chain'; style='font-size:28px;color:BlueViolet'></i>";
			};
			var printSubscribeIcon = function(cell, formatterParams){ //plain text value
				return "<i class='fa fa-plus-square'  style='font-size:28px;color:BlueViolet '></i>";
			};



            $("#allQueryTableReserved").tabulator({
                // layout:"fitDataFill",
                // tooltips:true,
                // responsiveLayout:"collapse",
                // addRowPos:"top",
                //                history:true,
//                pagination:"local",
//                paginationSize:7,
//               movableColumns:true,
                resizableRows:true,
                initialSort:[
                    {column:"name", dir:"asc"},
                ],
                columns:[ // Define Table Columns

                    // {formatter:"responsiveCollapse", width:30, minWidth:30, align:"center", resizable:false, headerSort:false},
                    {title:"행사 이름", field:"name", width:"18px"},
                    {title:"예정발표일", field:"announceDate", align:"center", sorter:"date", width:"12px"},
                    {title:"예정발표일(타임스탬프)", field:"tsAnnounceDate", align:"center", sorter:"date", width:"12px"},
                    {title:"참가자 수", field:"numOfRegistered", align:"center", width:"9px"},
                    {title:"우승자 수", field:"numOfWinners", align:"center", width:"9px"},
                    {title:"참여", field:"subscribe", formatter:printSubscribeIcon, align:"center", width:"9px", 
                        cellClick:function(e, cell){
                            var lotteryName = cell.getRow().getData().name;
                            var ts = cell.getRow().getData().tsAnnouncementDate;
                            var curr_ts = Math.floor(Date.now() / 1000);
                            if (curr_ts >= ts) {
                                Swal({type:"error", title:"참여 기한이 마감되었습니다"});
                                return;
                            }
                            Swal({
                                title: '(' + lotteryName + ')' + '\n이름을 입력하세요',
                                type: 'question',
                                input: 'text',
                                showCancelButton: true,
                                confirmButtonText: '확인',
                                cancelButtonText: '취소'
                            }).then((result) => {
                                showSpinner();
                                if (result.value) {
                                    var functionName = "subscribe";
                                    var participantName = result.value;
                                    if (participantName.indexOf(',') > -1) {
                                        Swal("이름에 콤마(,)는 포함될 수 없습니다.")
                                        hideSpinner();
                                        return;
                                    }
                                    var lotteryName = cell.getRow().getData().name;
                                    var eventHash = cell.getRow().getData().eventHash;
                                    // 보내기
                                    var allData = {
                                        "functionName" : functionName,
                                        "participantName" : participantName,
                                        "lotteryName" : lotteryName,
                                        "eventHash" : eventHash,
                                    };

                                    $.ajax({
                                        url: "http://141.223.121.175:1185" + "/subscribe",
                                        type: "POST", 
                                        data: allData,
                                        success: function(responseData) {
                                            Swal(
                                                '참여 성공',
    "<b>\"" + participantName + "\" </b>님이 " 
    + "<b>\"" + lotteryName + "\"" + ' </b>행사에 등록!'
    + "<br/>인증토큰" + responseData + "<br/><b><font color=\"red\">인증토큰은 당첨자임를 증명하기 위해서 반드시 갖고 있어야 합니다</font><br/>(복사해두세요)</b>",
                                                'success'
                                            )
                                            hideSpinner();
                                        },
                                        error: function() {
                                            Swal(
                                                '참여!',
                                                '참가자 등록 실패',
                                                'error'
                                            )
                                            hideSpinner();
                                        }
                                    })
                                    // For more information about handling dismissals please visit
                                    // https://sweetalert2.github.io/#handling-dismissals
                                } else if (result.dismiss === Swal.DismissReason.cancel) {
                                            hideSpinner();
                                }
                            })
                            // alert("Printing row data for: " + cell.getRow().getData().name);
                            // 기존의 subscribe 함수 호출
                        }
                    },

                    {title:"추첨", field:"draw", formatter:printDrawIcon, align:"center", width:"8px",
                        cellClick:function(e, cell) {
                            swal("추첨하기");
                        }
                    },

                    {title:"결과 확인", field:"check", formatter:printCheckVerify, align:"center", width:"8px",
                        cellClick:function(e, cell) {
                            var lotteryName = cell.getRow().getData().name;
                            var targetBlockNumber = cell.getRow().getData.targetBlock;
                            var announceDate = cell.getRow().getData().announceDate;
                            swal("("+ lotteryName + ")</br>결과 확인</br>" + cell.getRow().getData().winnerList);
                        }
                    },

                    {title:"검증", field:"verify",formatter:printCheckVerify, align:"center", width:"8px",
                        cellClick:function(e, cell){
                            var lotteryName = cell.getRow().getData().name;
                            var targetBlock = cell.getRow().getData().targetBlock;
                            var participantList = cell.getRow().getData().participantList;
                            var kRegistered = cell.getRow().getData().numOfRegistered;
                            if(kRegistered == 0) {
                                swal({type:"error", title:"참가자가 아무도 없습니다"});
                                return;
                            } 

                            // Validate appropriate date
                            var ts = cell.getRow().getData().tsAnnouncementDate;
                            var curr_ts = Math.floor(Date.now() / 1000);
                            if (curr_ts <= ts) {
                                Swal({type:"error", title:"발표일이 지나고 결과 추첨이 되어야 검증을 수행할 수 있습니다"});
                                return;
                            }

                            var numOfWinners = cell.getRow().getData().numOfWinners;
                            var verification = false;
                            // Define query block func

                            var queryBlock = function(height) {
                                var blockQueryBaseURL = "https://api.blockcypher.com/v1/btc/main/blocks/";
                                $.ajax({
                                    url: blockQueryBaseURL + height,
                                    type: "GET", 
                                    dataType: 'json',
                                    contentType: 'text/plain',
                                    crossDomain:true,
                                }).done(function(json) {
                                    var time = json.time;
                                    var blockHash = json.hash;
                                    console.log(blockHash);
                                    var prev_block = json.prev_block;
                                    // split participantList into array
                                    var participantArray = participantList.split(",").filter(function(x) {
                                        return (x.length > 0) && (x !== (undefined || null || " " || ' ' || '' || ""));
                                    });

                                    participantArray = participantArray.filter(item => item !== '');
                                    for (var i = 0; i < participantArray.length; ++i) {
                                        participantArray[i] = participantArray[i].replace(/ /g, '');
// if (participantArray[i].length )
                                        console.log(participantArray[i]);
                                    }
                                    var parseHexString = function(str) { 
                                        var result = [];
                                        while (str.length >= 8) { 
                                            result.push(parseInt(str.substring(0, 8), 16));

                                            str = str.substring(8, str.length);
                                        }

                                        return result;
                                    }
                                    var numOfParticipants = participantArray.length;
                                    var concatenated = "";
                                    var randomBits = "";
                                    console.log(blockHash);
                                    var j, x, i;
                                    var outputText = "";
                                    for (i = numOfParticipants - 1; i > 0; i--) {
                                        concatenated = blockHash + "" + i;
                                        // var randomseed = parseHexString(sjcl.hash.sha256.hash(concatenated));
                                        var randomseed = sjcl.hash.sha256.hash(concatenated);
                                        console.log(randomseed);
                                        j = Math.floor(randomseed * (i + 1));
                                        x = participantArray[i];
                                        participantArray[i] = participantArray[j];
                                        participantArray[j] = x;
                                    }
                                    // Error 왜 undefined가 생기지?
                                    var participantArray = participantList.split(",").filter(function(x) {
                                        return (x.length > 0) && (x !== (NaN || undefined || null || " " || ' ' || '' || ""));
                                    });
                                    for (var i = 0; i < participantArray.length; ++i) {
                                        participantArray[i] = participantArray[i].replace(/ /g, '');
                                        participantArray[i] = participantArray[i].replace(/\n/g, '');
                                        // if (participantArray[i].length )
                                        console.log(participantArray[i]);
                                    }
                                    console.log(participantArray);

                                    var firstNchars = 10;
                                    outputText = "처음 " + firstNchars + " 글자까지만 표현\n"
                                    for (i = 0; i < numOfWinners; ++i) {
                                        outputText += "<font color=\"red\">" + (i+1) + "</font> :" + participantArray[i].substring(0, 10) + "\n\n";
                                    }

                                    swal({
                                      title: outputText,
                                      // text: outputText ,
                                      width: 400,
                                      // height: 300,
                                      padding: 10,
                                      backdrop: `
                                        rgba(0,0,123,0.4)
                                        url("/images/Congratst.gif")
                                        left top
                                        no-repeat
                                      `
                                    });

                                    return json;
                            }).fail(function(textStatus, error) {
                                console.log("Error: " + textStatus + " " + error);
                                swal({type:"error", title: "타겟 블록이 생성되지 않았습니다"});

                            });};
                            // var block = queryBlock(400000);
                            var block = queryBlock(targetBlock);
                            // };
                    }},

                    {title:"정보", formatter:printIcon, field:"info", align:"center", width:"8px",
                        cellClick:function(e, cell) {
                            swal('추첨 행사 정보', 
                            "<b>행사 이름</b>: " + cell.getRow().getData().name + "</br>" +
                            "<b>타겟 블록</b> : " + cell.getRow().getData().targetBlock+ "</br>" +
                            "<b>참여자</b> : "  + cell.getRow().getData().participantList + "</br>" +
                            "<b>우승자</b>: " + cell.getRow().getData().winnerList + "</br>" +
                            "<b>등록일</b> : " + cell.getRow().getData().issueDate  + "</br>" +
                            "<b>마감일</b> : " + cell.getRow().getData().dueDate  + "</br>" + 
                            "<b>이벤트해시</b>: " + cell.getRow().getData().eventHash + "</br>" +
                            "<b>랜덤키</b> : " + cell.getRow().getData().verifiableKey + "</br>" +""
                            );
                        }
                    },

                    {title:"이벤트해시", field:"eventHash", align:"center", width:"12px"},
                    {title:"상태", field:"status", align:"center", width:"8px"},
                    {title:"타겟 블록", field:"targetBlock", align:"center", width:"8px"},
                    {title:"등록일", field:"issueDate", align:"center", width:"8px"},
                    {title:"마감일", field:"dueDate", align:"center", width:"8px"},
                    {title:"랜덤키", field:"verifiableKey", align:"center", width:"8px"},
                    {title:"우승자", field:"winnerList", align:"center", width:"8px"},
                    {title:"참여자", field:"participantList", align:"center", width:"8px"},
                    {title:"추첨 스크립트", field:"script",formatter:printScriptIcon, align:"center", width:"8px",
                        cellClick:function(e, cell){
                            var lotteryScript = cell.getRow().getData().script;
                            swal(lotteryScript);
                        }
                    },
                ],
            });

            var initTabledata = [
                {id:1, name:"불러오는 중", announceDate:"불러오는 중" }
               // {id:1, name:"sslab 친목", announceDate:"2018/04/27 12:30", numOfWinners: 3, subscribe:1, check:1, verify:1},
               // {id:2, name:"포스텍 세미나", announceDate:"2018/05/10 12:30", numOfWinners: 20, subscribe:1, check:1, verify:1},
               // {id:3, name:"블록체인 세미나", announceDate:"2018/05/12 14:00", numOfWinners: 5, subscribe:1, check:1, verify:1},
               // {id:3, name:"테스트", announceDate:"2018/05/12 14:00", numOfWinners: 5, subscribe:1, check:1, verify:1},
            ];

            // Re draw the table with new data from server
            $("#allQueryTableReserved").tabulator("setData", initTabledata);
            showSpinner();
            // Hide unnecesary columns to user
            if (true) {
                $("#allQueryTableReserved").tabulator("hideColumn", "eventHash");
                // $("#allQueryTableReserved").tabulator("hideColumn", "script");
                $("#allQueryTableReserved").tabulator("hideColumn","tsAnnounceDate");
                $("#allQueryTableReserved").tabulator("hideColumn", "status");
                $("#allQueryTableReserved").tabulator("hideColumn", "targetBlock");
                $("#allQueryTableReserved").tabulator("hideColumn","issueDate");
                $("#allQueryTableReserved").tabulator("hideColumn","dueDate");
                $("#allQueryTableReserved").tabulator("hideColumn","verifableKey");
                $("#allQueryTableReserved").tabulator("hideColumn","winnerList");
                $("#allQueryTableReserved").tabulator("hideColumn","participantList");
                $("#allQueryTableReserved").tabulator("hideColumn","verifiableKey");
            }

        } );
    </script>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
          <![endif]-->
</head>

    <body id="top">

        <div class="container-fluid">
            
            <div>
                <div class="row tm-color-row tm-bg-blue-1"></div>
                <div class="row tm-color-row tm-bg-blue-2"></div>
                <div class="row tm-header-row tm-bg-blue-3">
                    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 col-xl-12 text-xs-center">
                        
                        <h1 class="tm-text-blue-1 tm-h1">Blockchain on Lottery</h1>

                    </div>
                </div>

                <!-- 2. Navigation -->
                <div class="row tm-bg-blue-1">
                    <div class="tm-navbar-container">
                        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 col-xl-12">
                            <nav class="navbar navbar-full">                                
                                
                                <div class="text-xs-center tm-sm-bg-blue tm-navbar-rounded" id="tmNavbar">   
                                    <ul class="nav navbar-nav tm-nav">
                                        <li class="nav-item">
                                            <a href="index.html" class="nav-link">Home</a>
                                        </li>
                                    </ul>
                                </div>
                            </nav>  
                        </div>
                    </div>  
                </div>
            </div>            

            <!-- 1. Pack -->
            <div id="allQueryTableReserved" style="margin-top:20px;"></div>
            <div id="spinner" style="position: fixed; top:50%; left:50%; color: #3ccad1" class="la-ball-running-dots la-2x">
                <div></div>
                <div></div>
                <div></div>
                <div></div>
                <div></div>
                <div></div>
                <div></div>
            </div>

        
</body>
</html>
